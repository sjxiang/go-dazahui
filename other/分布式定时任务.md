# 分布式定时任务




定时任务：
    指系统为了自动完成特定任务，实时、延时、周期性完成任务调度的过程


按触发时机调度
    定时任务：特定时间触发，比如今天 15:06 执行
    延时任务：延时触发，比如 10s 后执行
    周期任务：固定周期时间，或固定频率周期调度触发，比如每天 12 点或者每隔 5s 执行



Linux 命令 - CronJob

    * * * * *

        min（0 - 59）
        hour（0 - 23）
        day of month（1 - 31）
        month（1 - 12）
        day of week （0 - 6）（sunday = 0，表示周日到周六）




单机定时任务 - Timer、Ticker

```golang

ticker := time.NewTicker(5 * time.Minute)
for {
    select {
    case <-ticker.C:
        SyncLocalCache()  // 每隔五分钟刷新本地缓存数据
    }
}

```





# 业务应用


业务领域

    电商
        订单 30 min 未付款，自动关闭
        定时给商家、达人发送消息，给用户发放优惠券

    社交互动
        支付宝集五福，除夕夜开奖
        字节春节集卡瓜分红包

    游戏
        活动结束后，批量补发用户未领取的奖励
        定时更新游戏内榜单


    总结：需要定时、延时、周期性执行任务的场景




其它解决方案

    发货后超过 10 天未收货时，系统自动确认收货
        - 使用消息队列 Kafka 的延时消息或者定时消息


    春节集卡活动，统计完成集卡的用户个数和总翻倍数
        - 使用大数据离线处理引擎 Hive 离线做统计
        - 使用大数据实时处理引擎 Flink 实时做累计



| 解决方案        | 时效性 | 可控性 | 简洁性 |  主要缺点|
| -------------- | ----- | ------ | ----- | ----- |
| 分布式定时任务  | 秒级   | 高     | 高   | -                                                  |
| 单机定时任务    | 秒级   | 高     | 高   | 无法支撑很大业务体量                                 |
| 消息队列延时消息| 实时   | 低     | 中   | 有任务变化时，已发送的延时消息不便于做变更             |
| 离线计算       | 小时级 | 中     | 高   | 时延至少小时级，会写 SQL 就好操作                     | 
| 实时计算       | 秒级   | 高     | 中   | 仅能做数据处理，无法调用 HTTP/RPC 请求完成业务逻辑处理；java scala spark，门槛高 |


